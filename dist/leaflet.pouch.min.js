(function(){L.GeoJSON.Pouch=L.GeoJSON.extend({defaultParams:{continuous:true,direction:"from"},initialize:function(e,t){var i,o,r,n,c=this;this._orig=[e,t];if(typeof e==="object"){t=e;e=void 0}if(e){if(e.slice(0,4)!=="http"){i=e;e=void 0}else if(e.slice(0,4)==="http"){if(t&&t.idbName){i=t.idbName}else{r=e.split("/");i=r.pop();while(i===""){i=r.pop()}}}}else{if(t&&t.idbName){i=t.idbName}else{r=location.href.split("/");i=r.pop();while(i===""){i=r.pop()}}}this._layers={};this._dbName=i;n=L.Util.extend({},this.defaultParams);for(o in t){if(n.hasOwnProperty(o)){n[o]=t[o]}}this.pouchParams=n;L.Util.setOptions(this,t);return Pouch(this._dbName,function(t,i){if(!t){c.localDB=i;c.localDB.changes({continuous:c.pouchParams.continuous,include_docs:true,onChange:function(e){var t;t=e.doc;if(parseInt(t._rev.slice(0,1))===1){if("geometry"in t){c.addData(t)}}else if(parseInt(t._rev.slice(0,1))>1){c.eachLayer(function(e){if(e.feature._id===t._id){return c.removeLayer(e)}});if("geometry"in t){if(!t._deleted){c.addData(t)}}}return true}});if(e){c.remoteDB=e;c.sync=function(e){var t,i;i={continuous:this.pouchParams.continuous};switch(this.pouchParams.direction){case"from":this._from=Pouch.replicate(this.localDB,this.remoteDB,i);break;case"to":this._to=Pouch.replicate(this.remoteDB,this.localDB,i);break;case"both":this._from=Pouch.replicate(this.localDB,this.remoteDB,i);this._to=Pouch.replicate(this.remoteDB,this.localDB,i);break;default:t=true}if(e){if(!t){e(null,true)}if(t){return e("No Option")}}};return c.sync()}}else if(e){return Pouch(e,function(e,t){if(!e){c.localDB=t;return c.localDB.changes({continuous:c.pouchParams.continuous,include_docs:true,onChange:function(e){var t;t=e.doc;if(parseInt(t._rev.slice(0,1))===1){if("geometry"in t){c.addData(t)}}else if(parseInt(t._rev.slice(0,1))>1){c.eachLayer(function(e){if(e.feature._id===t._id){return c.removeLayer(e)}});if("geometry"in t){if(!t._deleted){c.addData(t)}}}return true}})}})}})},addDoc:function(e,t){if(t==null){t=function(){return true}}if("type"in e&&e.type==="Feature"){if(!("_id"in e)){return this.localDB.post(e,t)}else if("_id"in e&&e._id.slice(0,8)!=="_design/"){return this.localDB.put(e,t)}}else if("type"in e&&e.type==="FeatureCollection"){return this.localDB.bulkDocs(e.features,t)}else if(e.length){return this.localDB.bulkDocs(e,t)}},getDoc:function(e,t){if(t==null){t=function(){return true}}return this.localDB.get(e,t)},deleteDoc:function(e,t){var i=this;if(t==null){t=function(){return true}}return this.getDoc(e,function(e,o){if(!e){i.localDB.remove(o,t)}if(e){return t("err")}})},cancel:function(e){switch(this.pouchParams.direction){case"from":this._from.cancel();break;case"to":this._to.cancel();break;case"both":this._from.cancel();this._to.cancel()}return e(null,true)},destroy:function(e){if(e==null){e=function(){return true}}return Pouch.destroy(this._dbName,e)}});L.geoJson.pouch=function(e,t){return new L.GeoJSON.Pouch(e,t)}}).call(this);